<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secure QR Middleware</title>
  <script src="config.js"></script>
  <script src="employees.js"></script>
</head>
<body>
  <h2>LGU QR Code Attendance</h2>
  <div id="content">
    <p><em>Fetching security check...</em></p>
  </div>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const empId = urlParams.get("emp_id");
  
    // Optional: Enable IP check here
    const useIPCheck = true; 
  
    function showError(message) {
      document.getElementById("content").innerHTML = `<h3 style="color:red;">${message}</h3>`;
    }
  
    function showEventCodeForm(emp) {
      const form = document.createElement("div");
  
      const info = document.createElement("p");
      info.innerHTML = `<strong>Employee:</strong> ${emp.name}<br>
                        <strong>Position:</strong> ${emp.position}<br>
                        <strong>Department:</strong> ${emp.department}`;
      form.appendChild(info);
  
      const codeInput = document.createElement("input");
      codeInput.type = "password";
      codeInput.placeholder = "Enter Event Code";
      codeInput.style.marginRight = "8px";
  
      const button = document.createElement("button");
      button.innerText = "Submit";
      button.onclick = () => {
        if (codeInput.value === allowedEventCode) {
          window.location.href = emp.form_url;
        } else {
          alert("❌ Incorrect event code. Please try again.");
        }
      };
  
      form.appendChild(codeInput);
      form.appendChild(button);
  
      document.getElementById("content").innerHTML = "";
      document.getElementById("content").appendChild(form);
    }
  
    function initMiddleware(userIP = null) {
      if (!empId || !employees[empId]) {
        showError("Invalid or missing employee ID.");
        return;
      }
  
      if (useIPCheck && userIP && !allowedIPs.includes(userIP)) {
        showError("Unauthorized device. IP blocked.");
        return;
      }
  
      const emp = employees[empId];
      showEventCodeForm(emp);
    }
  
    if (useIPCheck) {
      fetch("https://api.ipify.org?format=json")
        .then(response => response.json())
        .then(data => initMiddleware(data.ip))
        .catch(() => showError("Failed to validate IP address."));
    } else {
      initMiddleware(); // Skip IP check
    }
  </script>
</body>
</html>
